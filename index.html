<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>주식스레드 | 정보공유방</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --text-primary: #1e293b; --text-secondary: #64748b; --card-bg: white; --border-color: #e2e8f0; --accent: #3b82f6;
        }
        .dark-mode {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-primary: #e2e8f0; --text-secondary: #94a3b8; --card-bg: #1e293b; --border-color: #334155; --accent: #60a5fa;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: background 0.3s ease, color 0.3s ease; }
        .news-card { transition: all 0.3s ease; position: relative; overflow: hidden; background: var(--card-bg); border: 1px solid var(--border-color); animation: fadeIn 0.5s ease-out forwards; }
        .news-card:hover { transform: translateY(-6px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .read-badge { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); color: white; font-size: 11px; padding: 4px 8px; border-radius: 99px; z-index: 10; font-weight: bold; }
        .category-filter { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .filter-btn:not(.active) { background: var(--card-bg); color: var(--text-secondary); }
        .fixed-btn { position: fixed; width: 50px; height: 50px; background: var(--accent); color: white; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s, transform 0.3s; }
        .dark-toggle { right: 20px; bottom: 20px; }
        #toTopBtn { right: 20px; bottom: 80px; opacity: 0; transform: translateY(10px); pointer-events: none; }
        #toTopBtn.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .date-divider { font-size: 1rem; font-weight: bold; margin: 32px 0 16px 0; padding-bottom: 8px; border-bottom: 2px solid var(--accent); display: inline-block; }
        .recent-item { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; transition: background 0.2s; }
        .recent-item:hover { background-color: var(--bg-secondary); }
        .recent-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; flex-shrink: 0; }
        
        /* ✨ [개선] 스켈레톤 UI 카드 디자인 개선 */
        .skeleton-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; overflow: hidden; }
        .skeleton-img { height: 12rem; background-color: var(--bg-secondary); border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .skeleton-text { height: 1rem; margin-top: 0.75rem; background-color: var(--bg-secondary); border-radius: 0.25rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }

        /* ✨ [개선] 카드 등장 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">

        <header class="text-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span class="text-white font-bold text-3xl">📈</span>
            </div>
            <h1 class="text-4xl font-bold" style="color: var(--text-primary);">주식 정보 채널</h1>
            <p class="text-lg" style="color: var(--text-secondary);">엄선된 최신 투자 정보를 확인하세요</p>
        </header>

        <button class="fixed-btn dark-toggle" onclick="toggleDarkMode()"><span id="theme-icon">🌙</span></button>
        <button id="toTopBtn" class="fixed-btn" onclick="scrollToTop()">🔝</button>

        <div class="mb-6 max-w-2xl mx-auto">
            <input type="text" placeholder="뉴스 검색..." oninput="searchNews(this.value)"
                class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                style="border-color: var(--border-color); background-color: var(--card-bg);"/>
        </div>

        <div id="categoryFilter" class="category-filter justify-center">
             </div>

        <div id="newsContainer" class="mt-6"> <div id="skeletonLoader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text w-3/4"></div><div class="skeleton-text w-1/2"></div></div>
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text w-3/4"></div><div class="skeleton-text w-1/2"></div></div>
                <div class="skeleton-card hidden lg:block"><div class="skeleton-img"></div><div class="skeleton-text w-3/4"></div><div class="skeleton-text w-1/2"></div></div>
            </div>
        </div>
        
        <div id="loadMoreContainer" class="text-center mt-8" style="display: none;">
            <button id="loadMoreBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">더 보기</button>
        </div>

        <div id="recentNewsSection" class="mt-16 max-w-3xl mx-auto">
            <h3 class="text-xl font-bold mb-4 text-center" style="color: var(--text-primary);">최근 본 뉴스</h3>
            <div id="recentNews" class="flex flex-wrap justify-center gap-4"></div>
        </div>
    </div>
    
    <script>
        // ✨ [개선] 설정 객체화
        const CONFIG = {
            csvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3enWguEMxeKP1MawVmW36ynVa9ImB7uVG4mFJiEObsDmJufNeOiHycSXf3iZWgIceYnu67iNUO0aX/pub?output=csv',
            itemsPerLoad: 9, // 한 번에 불러올 뉴스 개수
            corsProxy: 'https://api.allorigins.win/get?url=', // OG 이미지용 프록시
        };

        // --- 상태 관리 변수 ---
        let allNewsData = [];
        let filteredNews = [];
        let displayedItems = 0;
        let popularNewsCount = {};

        // --- DOM 요소 ---
        const newsContainer = document.getElementById('newsContainer');
        const categoryFilter = document.getElementById('categoryFilter');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const skeletonLoader = document.getElementById('skeletonLoader');

        // --- 유틸리티 함수 ---
        const getReadNews = () => JSON.parse(localStorage.getItem('readNews') || '[]');
        const isRead = (link) => getReadNews().some(item => item.link === link);
        const getSource = (link) => {
            try { return new URL(link).hostname.replace('www.', ''); } catch { return '알 수 없음'; }
        };

        // ✨ [핵심] OG 이미지 가져오기 함수
        async function fetchOGImage(url) {
            try {
                const response = await fetch(`${CONFIG.corsProxy}${encodeURIComponent(url)}`);
                if (!response.ok) return null;
                const data = await response.json();
                const html = data.contents;
                const match = html.match(/<meta\s+property="og:image"\s+content="([^"]+)"/);
                return match ? match[1] : null;
            } catch (error) {
                console.error('OG Image fetch error:', error);
                return null;
            }
        }
        
        // --- 핵심 렌더링 함수 ---
        const createNewsCardHTML = (news) => `
            <div class="news-card rounded-2xl flex flex-col" data-link="${news.link}">
                <div class="cursor-pointer flex-grow" onclick="handleCardClick(this)">
                    ${isRead(news.link) ? '<div class="read-badge">읽음</div>' : ''}
                    <div class="relative">
                        <img src="${news.image || 'https://placehold.co/600x400/9ca3af/ffffff?text=Image'}" alt="${news.title}" class="w-full h-48 object-cover rounded-t-2xl">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold mb-2 line-clamp-2" style="color: var(--text-primary);">${news.title}</h3>
                            <p class="text-sm mb-3 line-clamp-3" style="color: var(--text-secondary);">${news.summary}</p>
                        </div>
                        <div class="flex items-center justify-between text-xs mt-2" style="color: var(--text-secondary);">
                            <span class="font-medium">${news.source}</span>
                            <span>${news.date}</span>
                        </div>
                    </div>
                </div>
            </div>`;

        function renderNews(newsItems) {
            let container = newsContainer.querySelector('.news-grid');
            if (!container) {
                container = document.createElement('div');
                container.className = 'news-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                newsContainer.appendChild(container);
            }
            container.insertAdjacentHTML('beforeend', newsItems.map(createNewsCardHTML).join(''));
        }
        
        function updateUI() {
            const query = document.querySelector('input[type="text"]').value.trim().toLowerCase();
            const hash = decodeURIComponent(location.hash.substring(1));
            
            filteredNews = allNewsData.filter(news => {
                const categoryMatch = hash === '전체' || hash === '' || news.categories.includes(hash);
                if (!query) return categoryMatch;
                const searchMatch = news.title.toLowerCase().includes(query) || news.summary.toLowerCase().includes(query) || news.source.toLowerCase().includes(query);
                return categoryMatch && searchMatch;
            });

            newsContainer.innerHTML = '';
            displayedItems = 0;
            displayMoreNews();
        }
        
        // ✨ [개선] "더 보기" 기능 구현
        function displayMoreNews() {
            const nextItems = filteredNews.slice(displayedItems, displayedItems + CONFIG.itemsPerLoad);
            if(nextItems.length > 0) {
                renderNews(nextItems);
                displayedItems += nextItems.length;
            }
            
            // 더 보기 버튼 표시/숨김
            if (displayedItems >= filteredNews.length) {
                loadMoreBtn.parentElement.style.display = 'none';
            } else {
                loadMoreBtn.parentElement.style.display = 'block';
            }

            if (filteredNews.length === 0) {
                 newsContainer.innerHTML = '<p class="text-center py-12" style="color: var(--text-secondary);">표시할 뉴스가 없습니다.</p>';
            }
        }

        // --- 이벤트 핸들러 및 기타 함수 ---
        function handleCardClick(element) {
            const card = element.closest('.news-card');
            const link = card.dataset.link;
            const news = allNewsData.find(n => n.link === link);
            if (news) {
                window.open(link, '_blank');
                markAsRead(news);
            }
        }

        function markAsRead(news) {
            let readNews = getReadNews();
            readNews = readNews.filter(item => item.link !== news.link);
            readNews.unshift({ link: news.link, title: news.title, image: news.image });
            if (readNews.length > 5) readNews.length = 5;
            localStorage.setItem('readNews', JSON.stringify(readNews));
            updateRecentNews();
            // 실시간 '읽음' 배지 추가
            const card = document.querySelector(`.news-card[data-link="${news.link}"]`);
            if (card && !card.querySelector('.read-badge')) {
                card.querySelector('.cursor-pointer').insertAdjacentHTML('afterbegin', '<div class="read-badge">읽음</div>');
            }
        }
        
        function updateRecentNews() {
            const recentNewsContainer = document.getElementById('recentNews');
            const readNews = getReadNews();
            if (readNews.length === 0) {
                recentNewsContainer.innerHTML = '<p class="text-center w-full" style="color: var(--text-secondary);">아직 본 뉴스가 없습니다</p>';
                return;
            }
            recentNewsContainer.innerHTML = readNews.map(item => `
                <a href="${item.link}" target="_blank" class="recent-item bg-white/50 dark:bg-slate-800/50 p-2 rounded-lg w-full max-w-sm flex items-center gap-3">
                    <img src="${item.image || 'https://placehold.co/60x60/9ca3af/ffffff?text=N'}" alt="${item.title}" class="recent-img">
                    <p class="font-medium text-sm line-clamp-2" style="color: var(--text-primary);">${item.title}</p>
                </a>`).join('');
        }

        let searchDebounce;
        function searchNews() {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(updateUI, 300);
        }

        // ✨ [개선] URL 해시 관리
        const updateURLHash = (category) => { location.hash = encodeURIComponent(category); };
        function applyFilterFromURL() {
            const category = decodeURIComponent(location.hash.substring(1)) || '전체';
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
            updateUI();
        }

        // --- 초기화 함수 ---
        async function loadData() {
            try {
                const response = await fetch(CONFIG.csvUrl);
                const csv = await response.text();
                let lines = csv.split('\n').slice(1).reverse();
                lines = [...new Set(lines.filter(line => line.trim() !== ''))]; // 중복 제거

                const newsPromises = lines.map(async (row) => {
                    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(col => col.trim().replace(/^"(.*)"$/, '$1')) || [];
                    if (!cols[1] || !cols[1].startsWith('http')) return null;
                    const link = cols[1];
                    const newsItem = {
                        link: link,
                        title: cols[0] || getSource(link) + ' 뉴스',
                        summary: cols[2] || '이 뉴스의 요약입니다. 자세한 내용은 링크를 확인하세요.',
                        date: cols[4] || new Date().toISOString().split('T')[0],
                        categories: (cols[6] || '기타').split(',').map(c => c.trim()),
                        source: getSource(link),
                        image: null
                    };
                    newsItem.image = await fetchOGImage(link); // 썸네일 가져오기
                    return newsItem;
                });
                
                allNewsData = (await Promise.all(newsPromises)).filter(Boolean);
                
                // 카테고리 필터 동적 생성
                const categories = ['전체', ...new Set(allNewsData.flatMap(news => news.categories))];
                categoryFilter.innerHTML = categories.map(cat => `<button class="filter-btn" data-category="${cat}">${cat}</button>`).join('');
                document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => updateURLHash(btn.dataset.category)));

                // 로딩 완료 후 UI 업데이트
                skeletonLoader.style.display = 'none';
                applyFilterFromURL();
                updateRecentNews();

            } catch (error) {
                console.error('데이터 로딩 실패:', error);
                newsContainer.innerHTML = `<div class="text-center p-8 bg-red-50 rounded-2xl"><p class="text-red-600 font-medium">로딩 실패</p><button onclick="location.reload()" class="mt-3 bg-red-600 text-white px-4 py-2 rounded-lg text-sm">다시 시도</button></div>`;
            }
        }
        
        // --- 다크모드 및 페이지 상단 이동 버튼 ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('theme-icon').textContent = isDark ? '☀️' : '🌙';
        }
        const toTopBtn = document.getElementById('toTopBtn');
        window.onscroll = () => { toTopBtn.classList.toggle('show', document.body.scrollTop > 200 || document.documentElement.scrollTop > 200); };
        const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        // --- 앱 시작 ---
        window.addEventListener('hashchange', applyFilterFromURL);
        loadMoreBtn.addEventListener('click', displayMoreNews);
        
        // 다크모드 초기 설정
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) document.body.classList.add('dark-mode');
        document.getElementById('theme-icon').textContent = isDark ? '☀️' : '🌙';

        loadData();
    </script>
</body>
</html>
