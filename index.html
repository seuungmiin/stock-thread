<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>주식스레드 | 정보공유방</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --text-primary: #1e293b; --text-secondary: #64748b; --card-bg: white; --border-color: #e2e8f0; --accent: #3b82f6;
        }
        .dark-mode {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-primary: #e2e8f0; --text-secondary: #94a3b8; --card-bg: #1e293b; --border-color: #334155; --accent: #60a5fa;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-primary); color: var(--text-primary); }
        .news-card { transition: all 0.3s ease; position: relative; background: var(--card-bg); border: 1px solid var(--border-color); animation: fadeIn 0.5s ease-out forwards; }
        .news-card:hover { transform: translateY(-6px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .read-badge { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); color: white; font-size: 11px; padding: 4px 8px; border-radius: 99px; z-index: 10; font-weight: bold; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .fixed-btn { position: fixed; width: 50px; height: 50px; background: var(--accent); color: white; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s, transform 0.3s; }
        #toTopBtn { right: 20px; bottom: 80px; opacity: 0; transform: translateY(10px); pointer-events: none; }
        #toTopBtn.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        /* ✨ [개선] 새 뉴스 알림 바 스타일 */
        #new-news-alert {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: top 0.4s ease-in-out;
        }
        #new-news-alert.show { top: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">
    <div id="new-news-alert" class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow-lg">
        <span id="new-news-count"></span>개의 새로운 뉴스가 있습니다.
        <button onclick="applyFreshData()" class="font-bold ml-2 underline">업데이트</button>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="text-center mb-8">
             <div class="w-16 h-16 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span class="text-white font-bold text-3xl">📈</span>
            </div>
            <h1 class="text-4xl font-bold">주식 정보 채널</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">엄선된 최신 투자 정보를 확인하세요</p>
        </header>

        <button class="fixed-btn dark-toggle right-5 bottom-5" onclick="toggleDarkMode()"><span id="theme-icon">🌙</span></button>
        <button id="toTopBtn" class="fixed-btn" onclick="scrollToTop()">🔝</button>

        <div class="mb-6 max-w-2xl mx-auto">
            <input type="text" placeholder="뉴스 검색..." oninput="searchNews(this.value)"
                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-gray-800"/>
        </div>

        <div id="categoryFilter" class="flex flex-wrap gap-2 justify-center mb-6"></div>
        <div id="newsContainer" class="mt-6"></div>
        <div id="loadMoreContainer" class="text-center mt-8" style="display: none;">
            <button id="loadMoreBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">더 보기</button>
        </div>
    </div>
    
    <script>
        const CONFIG = {
            csvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3enWguEMxeKP1MawVmW36ynVa9ImB7uVG4mFJiEObsDmJufNeOiHycSXfiZWgIceYnu67iNUO0aX/pub?output=csv',
            itemsPerLoad: 9,
            corsProxy: 'https://api.allorigins.win/get?url=',
            cacheDuration: 10 * 60 * 1000, // 10분
        };

        let allNewsData = [];
        let freshNewsData = []; // ✨ 새로 받아온 데이터를 임시 저장
        let filteredNews = [];
        let displayedItems = 0;

        const newsContainer = document.getElementById('newsContainer');
        const categoryFilter = document.getElementById('categoryFilter');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        
        // ✨ [핵심 개선] 이미지 비동기 로딩 및 업데이트 함수
        async function loadAndSetImage(cardElement, url) {
            try {
                const response = await fetch(`${CONFIG.corsProxy}${encodeURIComponent(url)}`);
                if (!response.ok) return;
                const data = await response.json();
                const html = data.contents;
                const match = html.match(/<meta\s+property="og:image"\s+content="([^"]+)"/);
                if (match && match[1]) {
                    const imgElement = cardElement.querySelector('img');
                    imgElement.src = match[1];
                }
            } catch (error) { /* 에러 시 조용히 무시 */ }
        }

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const card = entry.target;
                    const link = card.dataset.link;
                    loadAndSetImage(card, link);
                    observer.unobserve(card);
                }
            });
        }, { rootMargin: '0px 0px 200px 0px' });
        
        // ✨ [개선] 로고를 기본 이미지로 사용
        const createNewsCardHTML = (news) => {
            const sourceHost = new URL(news.link).hostname;
            const logoUrl = `https://logo.clearbit.com/${sourceHost}`;
            return `
            <div class="news-card rounded-2xl flex flex-col" data-link="${news.link}">
                <div class="cursor-pointer flex-grow" onclick="handleCardClick(this)">
                    ${isRead(news.link) ? '<div class="read-badge">읽음</div>' : ''}
                    <div class="relative">
                        <img src="${logoUrl}" onerror="this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Image';" alt="${news.title}" class="w-full h-48 object-cover rounded-t-2xl">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold mb-2 line-clamp-2">${news.title}</h3>
                        <p class="text-sm mb-3 line-clamp-3 text-gray-600 dark:text-gray-400">${news.summary}</p>
                        <div class="flex-grow"></div>
                        <div class="flex items-center justify-between text-xs mt-2 text-gray-500 dark:text-gray-400">
                            <span class="font-medium">${news.source}</span>
                            <span>${news.date}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderNews(newsItems) {
            let container = newsContainer.querySelector('.news-grid');
            if (!container) {
                container = document.createElement('div');
                container.className = 'news-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                newsContainer.appendChild(container);
            }
            container.insertAdjacentHTML('beforeend', newsItems.map(createNewsCardHTML).join(''));
            
            const newCards = Array.from(container.children).slice(displayedItems);
            newCards.forEach(card => imageObserver.observe(card));
        }

        function updateUI() {
            const query = document.querySelector('input[type="text"]').value.trim().toLowerCase();
            const hash = decodeURIComponent(location.hash.substring(1));
            
            filteredNews = allNewsData.filter(news => {
                const categoryMatch = hash === '전체' || hash === '' || news.categories.includes(hash);
                if (!query) return categoryMatch;
                const searchMatch = news.title.toLowerCase().includes(query) || news.summary.toLowerCase().includes(query) || news.source.toLowerCase().includes(query);
                return categoryMatch && searchMatch;
            });

            newsContainer.innerHTML = '';
            displayedItems = 0;
            displayMoreNews();
        }

        function displayMoreNews() {
            const nextItems = filteredNews.slice(displayedItems, displayedItems + CONFIG.itemsPerLoad);
            if (nextItems.length > 0) {
                renderNews(nextItems);
                displayedItems += nextItems.length;
            }
            loadMoreBtn.parentElement.style.display = displayedItems >= filteredNews.length ? 'none' : 'block';
            if (filteredNews.length === 0 && displayedItems === 0) {
                newsContainer.innerHTML = '<p class="text-center py-12 text-gray-500">표시할 뉴스가 없습니다.</p>';
            }
        }
        
        // ✨ [핵심 개선] 캐시된 데이터 로드 및 신규 데이터 백그라운드 페치
        async function initialize() {
            const cachedData = JSON.parse(localStorage.getItem('newsCache'));
            const lastFetch = localStorage.getItem('newsLastFetch');
            const now = new Date().getTime();

            if (cachedData && lastFetch && (now - lastFetch < CONFIG.cacheDuration)) {
                allNewsData = cachedData;
                setupUI();
                console.log("🚀 Cached data loaded instantly.");
            } else {
                newsContainer.innerHTML = '<p class="text-center py-12 text-gray-500">최신 뉴스를 불러오는 중...</p>';
                await fetchAndCacheData();
                setupUI();
                console.log("🐢 Fresh data fetched and loaded.");
            }
            // 백그라운드에서 조용히 데이터 업데이트 확인
            fetchFreshDataSilently();
        }

        async function fetchAndCacheData() {
            try {
                const response = await fetch(CONFIG.csvUrl + `&t=${new Date().getTime()}`); // Cache busting
                const csv = await response.text();
                const lines = [...new Set(csv.split('\n').slice(1).reverse())].filter(line => line.trim() !== '');

                allNewsData = lines.map(parseCSVRow).filter(Boolean);
                localStorage.setItem('newsCache', JSON.stringify(allNewsData));
                localStorage.setItem('newsLastFetch', new Date().getTime());
            } catch (error) {
                console.error('데이터 로딩 실패:', error);
                newsContainer.innerHTML = `<div class="text-center p-8 bg-red-100 rounded-2xl"><p class="text-red-600 font-medium">데이터 로딩에 실패했습니다.</p></div>`;
                allNewsData = [];
            }
        }

        async function fetchFreshDataSilently() {
            try {
                const response = await fetch(CONFIG.csvUrl + `&t=${new Date().getTime()}`);
                const csv = await response.text();
                const lines = [...new Set(csv.split('\n').slice(1).reverse())].filter(line => line.trim() !== '');
                freshNewsData = lines.map(parseCSVRow).filter(Boolean);

                const currentLinks = new Set(allNewsData.map(n => n.link));
                const newItems = freshNewsData.filter(n => !currentLinks.has(n.link));
                
                if (newItems.length > 0) {
                    console.log(`${newItems.length} new items found.`);
                    const alertEl = document.getElementById('new-news-alert');
                    document.getElementById('new-news-count').textContent = newItems.length;
                    alertEl.classList.add('show');
                } else {
                    console.log("No new items.");
                     // 새 데이터가 없다면 캐시만 갱신
                    localStorage.setItem('newsCache', JSON.stringify(freshNewsData));
                    localStorage.setItem('newsLastFetch', new Date().getTime());
                }
            } catch (error) {
                console.error("Silent fetch failed:", error);
            }
        }
        
        // ✨ 새 데이터 적용 함수
        function applyFreshData() {
            allNewsData = freshNewsData;
            localStorage.setItem('newsCache', JSON.stringify(allNewsData));
            localStorage.setItem('newsLastFetch', new Date().getTime());
            setupUI(); // UI 전체 새로고침
            const alertEl = document.getElementById('new-news-alert');
            alertEl.classList.remove('show');
        }

        function parseCSVRow(row) {
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(col => col.trim().replace(/^"(.*)"$/, '$1')) || [];
            if (!cols[1] || !cols[1].startsWith('http')) return null;
            return {
                link: cols[1],
                title: cols[0] || new URL(cols[1]).hostname,
                summary: cols[2] || '요약 정보가 없습니다.',
                date: cols[4] || new Date().toISOString().split('T')[0],
                categories: (cols[6] || '기타').split(',').map(c => c.trim()),
                source: new URL(cols[1]).hostname.replace('www.', ''),
            };
        }
        
        // UI 설정 통합 함수
        function setupUI() {
            const categories = ['전체', ...new Set(allNewsData.flatMap(news => news.categories))];
            categoryFilter.innerHTML = categories.map(cat => `<button class="filter-btn" data-category="${cat}">${cat}</button>`).join('');
            document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => location.hash = encodeURIComponent(btn.dataset.category)));
            applyFilterFromURL();
        }

        // --- 유틸리티 및 이벤트 핸들러 ---
        const getReadNews = () => JSON.parse(localStorage.getItem('readNews') || '[]');
        const isRead = (link) => getReadNews().some(item => item.link === link);

        function handleCardClick(element) {
            const card = element.closest('.news-card');
            const link = card.dataset.link;
            const news = allNewsData.find(n => n.link === link);
            if (news) {
                window.open(link, '_blank');
                markAsRead(news);
            }
        }

        function markAsRead(news) {
            let readNews = getReadNews();
            readNews = readNews.filter(item => item.link !== news.link);
            readNews.unshift({ link: news.link, title: news.title });
            if (readNews.length > 5) readNews.length = 5;
            localStorage.setItem('readNews', JSON.stringify(readNews));
            const card = document.querySelector(`.news-card[data-link="${news.link}"]`);
            if (card && !card.querySelector('.read-badge')) {
                card.querySelector('.cursor-pointer').insertAdjacentHTML('afterbegin', '<div class="read-badge">읽음</div>');
            }
        }
        
        let searchDebounce;
        const searchNews = () => { clearTimeout(searchDebounce); searchDebounce = setTimeout(updateUI, 300); }
        const applyFilterFromURL = () => {
            const category = decodeURIComponent(location.hash.substring(1)) || '전체';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
            updateUI();
        };

        const toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('theme-icon').textContent = isDark ? '☀️' : '🌙';
        };
        
        const toTopBtn = document.getElementById('toTopBtn');
        window.onscroll = () => toTopBtn.classList.toggle('show', window.scrollY > 200);
        const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        // --- 앱 시작 ---
        window.addEventListener('hashchange', applyFilterFromURL);
        loadMoreBtn.addEventListener('click', displayMoreNews);
        
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) document.body.classList.add('dark-mode');
        document.getElementById('theme-icon').textContent = isDark ? '☀️' : '🌙';

        initialize(); // ✨ 시작 함수 변경
    </script>
</body>
</html>
